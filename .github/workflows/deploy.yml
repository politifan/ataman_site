name: Deploy (FastAPI via Passenger)

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH key (Windows)
        env:
          DEPLOY_SSH_KEY_B64: ${{ secrets.DEPLOY_SSH_KEY_B64 }}
        run: |
          $ErrorActionPreference = "Stop"
          if ([string]::IsNullOrWhiteSpace($env:DEPLOY_SSH_KEY_B64)) {
            throw "DEPLOY_SSH_KEY_B64 is empty"
          }
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          New-Item -ItemType Directory -Force -Path $sshDir | Out-Null
          $keyPath = Join-Path $sshDir "id_ed25519"
          [IO.File]::WriteAllBytes($keyPath, [Convert]::FromBase64String($env:DEPLOY_SSH_KEY_B64))
          ssh-keygen -lf $keyPath
          ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_HOST }} | Out-File -Append -Encoding ascii (Join-Path $sshDir "known_hosts")

      - name: Upload via WinSCP (SFTP, mirror)
        run: |
          $ErrorActionPreference = "Stop"
          $host = "${{ secrets.DEPLOY_HOST }}"
          $port = "${{ secrets.DEPLOY_PORT }}"
          $user = "${{ secrets.DEPLOY_USER }}"
          $path = "${{ secrets.DEPLOY_PATH }}"
          $keyPath = Join-Path $env:USERPROFILE ".ssh\id_ed25519"
          if ([string]::IsNullOrWhiteSpace($path)) { throw "DEPLOY_PATH is empty" }

          $zip = Join-Path $env:TEMP "winscp.zip"
          $dir = Join-Path $env:TEMP "winscp"
          $exe = Join-Path $dir "WinSCP.com"
          Invoke-WebRequest -Uri "https://winscp.net/download/WinSCP-6.3.7-Portable.zip" -OutFile $zip
          if (Test-Path $dir) { Remove-Item -Recurse -Force $dir }
          Expand-Archive -Path $zip -DestinationPath $dir

          $script = @"
          option batch on
          option confirm off
          open sftp://$user@$host:$port/ -privatekey=""$keyPath"" -hostkey=*
          lcd ""$PWD""
          cd ""$path""
          synchronize remote -delete -mirror ""$PWD"" ""$path""
          exit
          "@
          $scriptPath = Join-Path $env:TEMP "winscp_script.txt"
          $script | Out-File -FilePath $scriptPath -Encoding ascii
          & $exe /script="$scriptPath" /log="$(Join-Path $env:TEMP 'winscp.log')"
          if ($LASTEXITCODE -ne 0) { throw "WinSCP failed with exit code $LASTEXITCODE" }

      - name: Run deploy script (Passenger restart)
        run: |
          $ErrorActionPreference = "Stop"
          $keyPath = Join-Path $env:USERPROFILE ".ssh\id_ed25519"
          ssh `
            -p ${{ secrets.DEPLOY_PORT }} `
            -i $keyPath `
            -o IdentitiesOnly=yes `
            -o BatchMode=yes `
            -o RequestTTY=no `
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} `
            "cd ${{ secrets.DEPLOY_PATH }} && chmod +x ./deploy.sh && ./deploy.sh"
